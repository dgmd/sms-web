<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <style>
    .message > div {
    	text-align: center;
    	width: calc(100%/3 - 2em);
    	padding: 1em;
    	display: inline-block;
    }
    .message:nth-child(2n) {
    	background-color: lightblue;
    }
    .message:nth-child(2n+1) {
    	background-color: lightgreen;
    }
    </style>
</head>

<body>
    <div id='messageDisplay'>
    </div>
    <script src="https://cdn.firebase.com/js/client/2.4.1/firebase.js"></script>
    <script>
    var messageDisplay = document.getElementById('messageDisplay');

    var divWrap = function(innerText, attrs) {
    	var div = document.createElement('div');
    	div.innerText = innerText;
    	Object.keys(attrs).forEach(function(attr) {
    		div.setAttribute(attr, attrs[attr]);
    	});
    	return div;
    };

    var Message = function(messageSid, fromNum, fromName, body) {
    	var self = this;
        self.messageSid = messageSid;
        var prettyNum = Array.prototype.slice.call(fromNum.replace(/^\+1/, ''));
        [
        	[0, '('],
        	[4, ') '],
        	[8, '-']
        ].forEach(function(splicePair) {
        	prettyNum.splice(splicePair[0], 0, splicePair[1]);
        });
        self.fromNum = prettyNum.join('');
        self.fromName = fromName.split(' ').reverse().join(' ');
        self.body = body;
        self.rowDiv = divWrap('', {class: 'message'});

        [
	        [self.fromName, 'name'],
        	[self.fromNum, 'number'],
        	[self.body, 'body']
        ].forEach(function(cellPair) {
        	var content = cellPair[0];
        	var attrList = {class: cellPair[1]};

        	self.rowDiv.appendChild(divWrap(content, attrList));
        });
    };

    var messages = [];

    var fb = new Firebase("https://sms-web.firebaseio.com/");
    fb.on('value', function(snapshot) {
        var data = snapshot.val();
        if (data) {
            Object.keys(data).forEach(function(mid) {
                var messageSids = messages.map(function(m) {
                    return m.messageSid
                });
                var isNewSid = messageSids.indexOf(mid == -1);
                if (isNewSid) {
                    var newMessage = new Message(mid, data[mid].from, data[mid].name, data[mid].body)
                    messages.push(newMessage);
                    messageDisplay.appendChild(newMessage.rowDiv);
                }
            });
        }
        else {
        	messageDisplay.innerHTML = 'Sorry, no data yetâ€¦';
        }
    });
    </script>
</body>

</html>
